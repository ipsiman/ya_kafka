
# Система потоковой фильтрации сообщений с блокировкой пользователей и цензурой

Это приложение на **Faust (Python)** обрабатывает поток сообщений в реальном времени, применяя:

1. **Блокировку пользователей** — каждый пользователь может вести свой список заблокированных. Сообщения от заблокированных не доходят до получателя.
2. **Цензуру слов** — сообщения автоматически очищаются от запрещённых слов (заменяются на `[CENSORED]`), при этом **сохраняются все знаки препинания и форматирование**.

---

## Архитектура

### Топики Kafka:

| Топик                  | Описание |
|------------------------|----------|
| `messages`             | Входящие сообщения: `{sender, recipient, text, timestamp}` |
| `blocked_users`        | Команды управления блокировками: `{user, blocked_user, action}` |
| `filtered_messages`    | Сообщения после обработки (без запрещённых слов и от незаблокированных отправителей) |

### Таблицы Faust:

| Таблица             | Описание |
|---------------------|----------|
| `blocked_users`     | Хранит для каждого пользователя список заблокированных (`list`). Персистентна через changelog-топик. |

---

## Классы и логика

### `Message` (модель)

- Представляет сообщение в системе.
- Сериализуется в JSON.
- Используется в топиках `messages` и `filtered_messages`.

---

### `BlockedUsersUpdate` (модель)

- Команда для управления списком блокировок.
- Обрабатывается агентом `process_blocked_users`.

---

### `CensorService` (логика цензуры)

Реализован в `app/censor.py`.

- Содержит множество запрещённых слов: `BANNED_WORDS`.
- Функция `censor_text(text: str) -> str`:
  - Сохраняет всю пунктуацию, пробелы, регистр и структуру текста.
  - Заменяет только "чистое" слово (без окружающей пунктуации) на `[CENSORED]`, если оно есть в списке.

Пример:  
`"Ты идиот, но я тебя люблю!"` → `"Ты [CENSORED], но я тебя люблю!"`

---

### Агенты Faust

#### 1. `process_blocked_users`

- Подписан на топик `blocked_users`.
- Обновляет таблицу `blocked_users_table`:
  - При `action: "add"` — добавляет пользователя в список.
  - При `action: "remove"` — удаляет из списка.
- Изменения автоматически сохраняются в changelog-топик.

#### 2. `process_messages`

- Подписан на топик `messages`.
- Для каждого сообщения:
  1. Проверяет, заблокирован ли `sender` у `recipient` (через `blocked_users_table`).
  2. Если да — отбрасывает сообщение.
  3. Если нет — применяет цензуру через `censor_text`.
  4. Отправляет результат в `filtered_messages`.

---

## Инструкция по запуску проекта

### Требования

- Docker
- Docker Compose
- Python 3.9+ (для запуска тестового скрипта)

---

### Шаг 1: Клонируйте репозиторий

```bash
git clone <ваш-репозиторий>
cd <папка-проекта>
```

---

### Шаг 2: Запустите инфраструктуру

```bash
docker-compose up
```

Подождите 2-3 минуты, пока Kafka-кластер и приложения инициализируются.

Kafka UI Интерфейс доступен на [http://localhost:8080](http://localhost:8080)

---

## Инструкция по тестированию

### Шаг 1: Установите зависимости для тестового скрипта

```bash
pip install confluent-kafka
```

---

### Шаг 2: Запустите тест

```bash
python producer_test.py
```

Скрипт:

1. Отправляет команду: `alice` блокирует `bob`.
2. Отправляет 2 сообщения:
   - от `bob` → должно быть отфильтровано.
   - от `charlie` → должно пройти с цензурой.
3. Читает из `filtered_messages` и проверяет результат.

---

### Ожидаемый вывод

```
Отправка команды блокировки...
Сообщение доставлено в blocked_users [0] @ offset 1
Команда блокировки отправлена.
Отправка тестовых сообщений...
Сообщение доставлено в messages [3] @ offset 2
Сообщение доставлено в messages [1] @ offset 0
Сообщение доставлено в messages [1] @ offset 1
Все сообщения отправлены.
Ожидание обработанных сообщений из 'filtered_messages' (таймаут 5 сек)...
Получено: {'sender': 'charlie', 'recipient': 'alice', 'text': 'Ты [CENSORED], но я тебя люблю!', 'timestamp': '2025-04-05T10:01:00Z', '__faust': {'ns': 'app.main.Message'}}
Получено: {'sender': 'tedd', 'recipient': 'mark', 'text': 'Hello my friend!', 'timestamp': '2025-04-05T10:04:00Z', '__faust': {'ns': 'app.main.Message'}}

============================================================
РЕЗУЛЬТАТЫ ТЕСТА:
============================================================
Цензура сработала: запрещённые слова заменены на [CENSORED]
Блокировка сработала: сообщения от bob не дошли до alice
============================================================
```

---

## Тестовые данные

Вы можете отправить свои данные вручную через Kafka UI или консоль.

### Пример команды блокировки:

```json
{
  "user": "alice",
  "blocked_user": "spam_bot",
  "action": "add"
}
```

→ Отправьте в топик `blocked_users`.

### Пример сообщения:

```json
{
  "sender": "friend",
  "recipient": "alice",
  "text": "Ты такой дурак, но я тебя обожаю!",
  "timestamp": "2025-04-05T12:00:00Z"
}
```

→ Отправьте в топик `messages`.

→ В `filtered_messages` должно появиться:  
`"Ты такой [CENSORED], но я тебя обожаю!"`

---

## Очистка

```bash
docker-compose down -v
```

---

## Готово!

Система полностью работоспособна, протестирована и готова к расширению.
